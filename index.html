<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>15パズル</title>
<meta name='description' content='きわめて一般的な15パズル。'>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138165866-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-138165866-1');
</script>
<link rel="stylesheet" href="style.css">
</head>

<body>

<header class="header">15パズル</header>
<main class="main">
  <div class="puzzle"></div>
  <div class="misc">
    <button class="reset" type="button">RESET</button>
    <button class="shuffle" type="button">SHUFFLE</button>
    <div class="move">move:<span class="move_num"></span></div>
  </div>
</main>

<script>
(function(d){
  "use strict";
  const pannels = [];
  let container = null;
  let moveNum;
  const moveNumSpan = d.querySelector(".move_num");

  const action = function(p) {
    const current = pannels.indexOf(p);
    const swap = function(next) {
      if (pannels[next] === null) {
        pannels[next] = p;
        pannels[current] = null;
        p.slide(next);
        return true;
      }
      return false;
    };

    if (swap(current - 4)) {
      return true;
    }

    if (swap(current + 4)) {
      return true;
    }

    const x = current % 4;
    if (x !== 0 && swap(current - 1)) {
      ;
      return true;
    }

    const right = current + 1;
    if (x !== 3 && swap(current + 1)) {
      return true;
    }
    return false;
  };

  const shuffle = function(times) {
    container.classList.remove("shuffled");
    const offset = [-4, 4, -1, 1];
    while (times-- > 0) {
      const blank = pannels.indexOf(null);
      const target = pannels[blank + offset[Math.random() * 4 | 0]];
      if (target) {
        action(target);
      }
    }
    container.classList.add("shuffled");
    checkFinish();
  };

  const checkFinish = function() {
    let origin = 0;
    for (let i = 0; i < 16; ++i) {
      const p = pannels[i];
      if (p === null) continue;
      if (p.dataset.idx === String(i)) {
        ++origin;
        p.classList.add("origin");
      } else {
        p.classList.remove("origin");
      }
    }
    return origin === 15;
  };

  const createPannel = function(num) {
    if (num > 14) {
      return null;
    }
    const ret = d.createElement("div");
    ret.dataset.idx = num;
    ret.slide = function(idx) {
      this.style.left = (idx % 4) * 25 + "%";
      this.style.top = (idx / 4 | 0) * 25 + "%";
    }
    ret.slide(num);
    ret.classList.add("puzzle_pannel");
    ret.addEventListener("click", function() {
      if (action(this)) {
        moveNumSpan.textContent = String(++moveNum);
        setTimeout(function(){
          if (checkFinish() && confirm("クリアです！ もう一度やりますか？")) {
            moveNum = 0;
            moveNumSpan.textContent = "0";
            shuffle(1000);
          }
        }, 400);
      };
    });

    const span = d.createElement("span");
    span.classList.add("puzzle_num");
    span.textContent = String(num + 1);
    ret.appendChild(span);
    container.appendChild(ret);
    return ret;
  };

  const init = function() {
    container = d.createElement("div");
    container.classList.add("puzzle_container");
    for (let i = 0; i < 16; ++i) {
      pannels.push(createPannel(i));
    }
    d.querySelector(".puzzle").appendChild(container);
    container.classList.add("shuffled");
    moveNum = 0;
    moveNumSpan.textContent = "0";
    checkFinish();
  };

  const reset = function() {
    pannels.sort(function(a, b) {
      const ax = a === null ? 16 : parseInt(a.dataset.idx);
      const bx = b === null ? 16 : parseInt(b.dataset.idx);
      return ax < bx ? -1 : 1;
    });
    for (let i = 0; i < 15; ++i) {
      pannels[i].slide(i);
    }
    moveNum = 0;
    moveNumSpan.textContent = "0";
    checkFinish();
  };

  init();
  d.querySelector(".reset").addEventListener("click", reset);
  d.querySelector(".shuffle").addEventListener("click", function(){
    shuffle(1000);
  });
})(document);
</script>
</body>
</html>


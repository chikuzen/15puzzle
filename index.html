<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>15パズル</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="header">15パズル</header>
<main class="main">
  <div class="puzzle"></div>
  <div class="misc">
    <button class="reset" type="button">RESET</button>
    <button class="shuffle" type="button">SHUFFLE</button>
    <div class="move">move:<span class="move_num"></span></div>
  </div>
</main>

<script>
(function(d){
  "use strict";
  const pannels = [];
  let container = null;
  let moveNum;
  const moveNumSpan = d.querySelector(".move_num");

  function action(p) {
    const x = parseInt(p.dataset.x);
    const y = parseInt(p.dataset.y);
    const current = x + 4 * y;

    const above = current - 4;
    if (pannels[above] === null) {
      pannels[above] = p;
      pannels[current] = null;
      p.slide(x, y - 1);
      return true;
    }

    const bellow = current + 4;
    if (pannels[bellow] === null) {
      pannels[bellow] = p;
      pannels[current] = null;
      p.slide(x, y + 1);
      return true;
    }

    const left = current - (x > 0 ? 1 : 0);
    if (pannels[left] === null) {
      pannels[left] = p;
      pannels[current] = null;
      p.slide(x - 1, y);
      return true;
    }

    const right = current + (x > 2 ? 0 : 1);
    if (pannels[right] === null) {
      pannels[right] = p;
      pannels[current] = null;
      p.slide(x + 1, y);
      return true;
    }
    return false;
  }

  function shuffle(times) {
    container.classList.remove("shuffled");
    while (times-- > 0) {
      const offset = [-4, 4, -1, 1];
      const blank = pannels.indexOf(null);
      if (blank < 4) {
        offset[0] = 4;
      }
      if (blank > 11) {
        offset[1] = -4;
      }
      if (blank % 4 === 0) {
        offset[2] = 1;
      }
      if (blank % 4 === 3) {
        offset[3] = -1;
      }
      action(pannels[blank + offset[Math.random() * 4 | 0]]);
    }
    container.classList.add("shuffled");
    checkFinish();
  }

  function checkFinish() {
    let origin = 0;
    for (let i = 0; i < 16; ++i) {
      const p = pannels[i];
      console.log(i, p);
      if (p === null) continue;
      if (p.dataset.idx === String(i)) {
        ++origin;
        p.classList.add("origin");
      } else {
        p.classList.remove("origin");
      }
    }
    if (origin < 15) return;
    if (confirm("クリアです！ もう一度やりますか？")) {
      moveNum = 0;
      moveNumSpan.textContent = "0";
      shuffle(100);
    }
  }

  function createPannel(x, y) {
    const num = y * 4 + x + 1;
    if (num > 15) {
      return null;
    }
    const ret = d.createElement("div");
    ret.dataset.idx = num - 1;
    ret.slide = function(dx, dy) {
      this.style.left = dx * 25 + "%";
      this.style.top = dy * 25 + "%";
      this.dataset.x = dx;
      this.dataset.y = dy;
    }
    ret.slide(x, y);
    ret.classList.add("puzzle_pannel");
    ret.addEventListener("click", function() {
      if (action(this)) {
        moveNumSpan.textContent = String(++moveNum);
        checkFinish();
      };
    });

    const span = d.createElement("span");
    span.classList.add("puzzle_num");
    span.textContent = String(num);
    ret.appendChild(span);

    container.appendChild(ret);
    return ret;
  }

  function init() {
    container = d.createElement("div");
    container.classList.add("puzzle_container");
    for (let y = 0; y < 4; ++y) {
      for (let x = 0; x < 4; ++x) {
        pannels.push(createPannel(x, y));
      }
    }
    d.querySelector(".puzzle").appendChild(container);
    container.classList.add("shuffled");
    moveNum = 0;
    moveNumSpan.textContent = String(moveNum);
  }

  function reset() {
    while (pannels.length > 0) {
      pannels.pop();
    }
    d.querySelector(".puzzle").removeChild(container);
    container = null;
    init();
  }

  init();
  d.querySelector(".reset").addEventListener("click", reset);
  d.querySelector(".shuffle").addEventListener("click", function(){
    shuffle(100);
  });
})(document);
</script>
</body>
</html>

